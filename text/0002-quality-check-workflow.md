# Table of Contents <!-- omit in toc -->

- [Introduction](#introduction)
- [Motivation](#motivation)
- [Discussion](#discussion)
- [Specification](#specification)
- [Items Still In-Progress](#items-still-in-progress)
- [Outstanding Questions](#outstanding-questions)

## Introduction

This RFC documents an automated workflow for assessing the integrity and quality of St. Jude Cloud genomics data. The goal of this RFC is two-fold.

1. Establish state of the art method for comprehensively evaluating genomics data quality at scale: both at time of receipt and after processing.
2. Publish a collection of metrics that end-users of St. Jude Cloud can leverage to assess the quality of the data available. This context should save users time computing the information themselves while also informing appropriate use of the data.

You can find the relevant discussion on the [associated pull request](https://github.com/stjudecloud/rfcs/pull/3).

## Motivation

St. Jude Cloud is one of the largest repositories of omics data available for request to date. As such, the project processes thousands of samples from whole genome, whole exome, RNA-Seq, and various omics-based assays each year. A standard, robust method to assess pre-processing and post-processing quality for samples has been developed in-house, but there are some shortcomings with our current approach. In particular, this RFC will attempt to

- define the standard set of QC tools used to evaluating omics-based data
- identify and implement key metrics that can be automated to assist in manual observation of the data, and
- publish these results alongside the data already published in St. Jude Cloud so that end-users can similar view results.

## Discussion

### Types of QC

There are (at least) two different types of QC typically carried out omics-based data. **Experiment** QC attempts to identify the success of the assay(s) performed. Once one is sufficiently satisfied that the data generated by an experiment is "good", **computational** QC examines the degree to which computational processing of that data was completed successfully.

By the time data reaches the St. Jude Cloud team from various sources, extensive _experimental_ and _computational_ evaluation have already been carried out. Each contributing project has its own thresholds for quality in both areas which is dependent on the best practices at that point in time and the goals of the project. Most often, we take the computational data, revert it back to its raw form (such as FastQ files), and reprocess it using our harmonization pipeline.

Thus, the scope of this RFC, and the QC of samples on the project in general, is limited to the _computational_ QC of the files produced for publication in St. Jude Cloud. While we do produce results that define _experimental_ results (such as `fastqc` ), these are rarely used to decide which files pass or fail our QC. We hope that the inclusion of these results will save end-users time and aide in decision-making about downstream analysis approaches.

### Whole genome sequencing metrics

#### General statistics

* **M Reads Mapped** _(produced by [samtools])_. Number of reads mapped in millions. The number of reads in a whole genome sequencing file can vary widely based on the experiment design and the sequencing depth of the project.
  * Typically, WGS files contain between 200M reads up to 2 billion reads (or higher in some cases). Any deviation outside of this range should be investigated further (particularly if the number is lower, which suggests that the file may be truncated).
  * This number is especially informative within the context of samples from the same cohort. We expect a normal distribution for this metric within the same sequencing cohort, special attention is required for any samples that do not conform to this distribution. 
* **GC Content** _(produced by [qualimap])_. Percentage of the nucleotides contained within reads which are Cs (Cytosine) or Gs (Guanine). GC content is important because Gs pair with Cs in DNA with 3 hydrogen bonds whereas As pair with Ts in DNA with 2 hydrogen bonds. Ergo, DNA is considered to be stronger when comprised of more GC bonds, and GC content is a defining characteristic of different genomes. GC content for humans is [estimated to be at around 41%](https://www.nature.com/articles/35057062#Sec15).
  * GC content in whole genome sequencing is typically between 40%-60% depending on sequencing bias. Any deviation outside of this range should be investigated further.
  * This number is especially informative within the context of samples from the same cohort. We expect GC content across samples to be tightly clustered within a cohort.
  * If either of the above assumptions do not hold true, probable sources of variance include library preparation abnormalities or contamination issues.
* **Median Insert Size** _(produced by [qualimap])_. Size of the fragment inserted between the adapters (in nucleotides). In whole genome sequencing experiments, typically you have a target fragment length for each sample (commonly ~2x the read length to maximize the amount of information gathered per fragment). The median insert size has proven to be an incredibly valuable statistic for identify mapping problems and experiment abnormalities.
  * Typically, the median insert size should be between 1.5x - 2x the read length of the experiment. This criteria may be evaluated loosely, as insert sizes that are close to this range (anything between 1x - 5x read length) do not necessarily indicate a major problem. Samples with an extremely low median insert size (10-40 nucleotides) are likely the cause of mapping artifacts—particularly if `bwa mem` was used with a low seed size.
  * This number is especially informative within the context of samples from the same cohort. We expect the median insert size across samples to be tightly clustered within a cohort.
* **≥ 30X** _(produced by [qualimap])_. Percentage of the genome which has at least 30 reads covering the position (otherwise known as "30x coverage"). 30x coverage at any location is widely considered to be the minimum number of reads needed to generate high confidence genotype call. In whole genome sequencing, it is desirable to have as much of the genome as possible to be covered by 30 or more reads. Expected genome coverage is often determined at the time of sequencing and may vary from project to project depending on cost and experiment design.
  * Target sequencing depth and fraction of the genome to be covered are generally set on a project by project basis. Speak with the someone on the sequencing team to ensure you understand what sequencing depth and fraction of the genome covered you should be expecting.
  * At a minimum, we expect 80% of the genome to be covered by at least 30 reads in high-quality whole genome sequencing experiments. For higher depth coverage projects like our Clinical Genomics project, the standard is 60x across 80% of the genome.
  * Less coverage does not necessarily indicate a problem, but in whole genome sequencing, anything below 65% of the genome at 30X signals that something may be going wrong. Pay close attention to the distribution of the reads across the genome by generating a coverage plot to see where sequencing bias is being introduced.
  * This number is especially informative within the context of samples from the same cohort. We expect this metric to be tightly clustered across samples within a cohort.
* **% Aligned** _(produced by [samtools])_. Percentage of the number of reads that were able to be mapped to a given reference genome. In whole genome sequencing, this metric is largely indicative of the amount of non-human material which was sequenced during the experiment.
  * This number is especially informative within the context of samples from the same cohort. We expect the percentage of aligned reads to be tightly clustered above 95% mapping rate. It is not uncommon for samples to go as low as 80% mapping rate, and this should be considered normally. Occasionally you may find small proportion of samples between 51%-79% mapping rate, but those samples should be investigated. Anything below 50% mapping rate signals an issue with contamination, and anything less than 30% mapping may be an issue with the mapper or the data integrity (e.g. mismatched read pairs).

| Name                               | Produced By | Description                                                                                                                                                                                                                                                                                                                                                                                         | Fourth Column |
| ---------------------------------- | ----------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- |
| M Reads Mapped                     | [samtools]  | Number of reads mapped in millions. This metric is useful                                                                                                                                                                                                                                                                                                                                           |               |
| % Aligned                          | [samtools]  | Number of mapped reads divided by the total number of reads as a percentage.                                                                                                                                                                                                                                                                                                                        |               |
| Per Base Sequence Quality          | [FastQC]    | The "Per Base Sequence Quality" module from FastQC shows the distribution of quality scores across all bases at each position in the reads. In our case, this is to inform our end users -- the quality of the sequencing run has already been assessed by the lab upstream.                                                                                                                        |               |
| Overrepresented Sequences          | [FastQC]    | The "Overrepresented Sequences" module from FastQC displays sequences (at least 20bp) that occur in more than 0.1% of the total number of sequences and will help identify contamination (vector, adapter sequences, etc.).                                                                                                                                                                         |               |
| Reads Genomic Origin               | [qualimap]  | The "Reads Genomic Origin" from Qualimap determines how many alignments fall into exonic, intronic, and intergenic regions. Even if there is a high genomic mapping rate, it is necessary to check where the reads are mapped. It should be verified that the mapping to intronic regions and exons are within acceptable ranges. Abnormal results could indicate issues such as DNA contamination. |               |
| rRNA Content                       | ?           | Verify that excess ribosomal content is filtered/normalized across samples to ensure that alignment rates and subsequent normalization of data is not skewed.                                                                                                                                                                                                                                       |               |
| Transcript Coverage and 5'-3' Bias | [qualimap]  | Libraries prepared with polyA selection may have higher biased expression in 3' region. If reads primarily accumulate at the 3' end of transcripts (in poly(A)-selected samples), this might indicate the starting RNA was of low quality.                                                                                                                                                          |               |
| Junction Analysis                  | [qualimap]  | Analysis of known, partly known, and novel junction positions in spliced alignments.                                                                                                                                                                                                                                                                                                                |               |
| Strand Specificity                 | ngsderive   | Verification/sanity check of how reads were stranded for the RNA sequencing (stranded or unstranded protocol).                                                                                                                                                                                                                                                                                      |               |
| GC Content Bias                    | ?           | GC profiles are typically remarkably stable. Even small/minor deviations could indicate a problem with the library used (or bacterial contamination).                                                                                                                                                                                                                                               |               |

#### Thresholds and Metrics for Specific Applications

To apply quality control metrics to vet data, we need reasonable thresholds that are practically achievable and neither too lax nor too strict. Our preference is for statistically or empirically determined thresholds rather than arbitrary estimates. By statistical thresholds, we are referring to distributional tests that formally define outliers. By empirical thresholds, we are referring to standards below which data analysis or interpretation are degraded. Statistical tests can be performed on large populations of QC data. We are already in a position to do that today. Empirical tests, however, require foreknowledge of the correct results. This requires experimental design and implementation through a laboratory at some cost.

#### Metrics for WGS

The quality metrics of special concern for WGS include depth of coverage and coverage distribution across genomic regions. Mapping quality is also critical. The analysis of whole genome sequencing to call variants depends on depth and sample purity. Accurate calls are made through replication and contamination creates false positives. So metrics that are sensitive to impurity are valuable.

#### Metrics for WES

The quality metrics of special concern for WES include depth of coverage in exonic regions. Mapping quality, mapping percentage, and duplication rate are also important.

#### Metrics for RNAseq

The quality metrics of special concern for RNA-Seq include mapping percentage, percentage properly paired reads, and exonic region coverage. Mapping quality is also critical.

## Specification

These are generic instructions for running each of the tools in our pipeline. We run our pipeline in a series of QC scripts that are tailored for our compute cluster, so those commands may not apply elsewhere. Instead, we have supplied examples of the commands used in each package. Our default memory is 80G and we employ 4 threads for these processes.

### Dependencies

We presume anaconda is available and installed. If not please follow the link to [anaconda](https://www.anaconda.com/) first.

```bash
conda create --name bio-qc \
    --channel bioconda \
    --channel conda-forge \
    fastqc==0.11.8 \
    picard==2.20.2  \
    qualimap==2.2.2c \
    samtools==1.9 \
    fastq-screen==0.13.0 \
    ngsderive==1.1.0 \
    multiqc==1.9 \
    -y

conda activate bio-qc
```

For linting created fastqs, `fqlib` must be installed. See installation instructions [here](https://github.com/stjude/fqlib)

### Workflow

The workflow specification is as follows. Note that some arguments that are not integral to the command (such as output directories) or arguments that can vary between compute environments (such as memory thresholds or number of threads) are not included.

1. Compute the md5 checksum of the file.

      ```bash
      md5sum $BAM
      ```

2. Use Picard's `ValidateSamFile` tool to ensure the inner contents of the BAM file are well-formed.

      ```bash
      picard ValidateSamFile \
          I=$BAM \                                        # specify bam file
          MODE=SUMMARY\                                   # concise output
          INDEX_VALIDATION_STRINGENCY=LESS_EXHAUSTIVE \   # lower stringency faster processing time
          IGNORE=INVALID_PLATFORM_VALUE                   # Validations to ignore.
      ```

3. Run `samtools flagstat` to gather general statistics such as alignment percentage.

    ```bash
    samtools flagstat $BAM
    ```

4. Run `fastqc` to collect sequencing and library-related statistics. These are only for informational purposes -- as stated above, we typically do not remove samples based on this information (with rare exception), as the sequencing-related QC work was done upstream in the genomics lab.

      ```bash
      fastqc $BAM
      ```

5. Run `ngsderive instrument` to infer sequencing instrument.

      ```bash
      ngsderive instrument $BAM
      ```

6. Run `ngsderive readlen` to infer read lengths.

      ```bash
      ngsderive readlen $BAM
      ```

7. Run `qualimap bamqc` to gather more in-depth statistics about read stats, coverage, mapping quality, mismatches, etc.

      ```bash
      qualimap bamqc -bam $BAM \          # bam filename
          -nt $NUM_THREADS \              # threads requested
          -nw 400                         # number of windows
      ```

8. If WGS or WES data, run `fastq_screen`. For performance, we subsample the input BAM using `samtools view -s $computed_fraction` before running it through `picard SamToFastq`. The resulting fastqs are validated with `fq lint` provided by `fqlib`.

      ```bash
      cat $fastq_1 $fastq_2 > $combined_fastq
         fastq_screen $combined_fastq
      ```

9. If RNA-Seq, run `ngsderive strandedness` to determine a backwards-computed strandedness of the RNA-Seq experiment.

      ```bash
      ngsderive strandedness
      ```

10. If RNA-Seq data, run `qualimap rnaseq` to gather QC statistics that are tailored for RNA-Seq files.

      ```bash
      qualimap rnaseq --java-mem-size=$MEM_SIZE \ # memory
         -bam $BAM \                              # bam filename
         -gtf $GTF_REF                            # transcript definition file
         [-pe]                                      # specify paired end if paired end
      ```

11. Combine all of the above metrics using `multiqc`.

      ```bash
      multiqc . # recurse all files in '.'
      ```

## Items Still In-Progress

- [ ] Analysis tools for other types of sequencing (ChIP-seq)
- [ ] Useful metadata from various stages (sample collection, laboratory, pre-sequencing, sequencing, post-sequencing)

## Outstanding Questions

- What thresholds or metrics differentiate a poor-quality sample from a high-quality one?
- What other metrics or properties would be valuable?
- What is best way to define and handle outliers?
- What is the best way to examine cohort integrity? This means experimental category-based tests of samples to find outliers that are of sufficient quality if examined alone. Outliers in this case may indicate classification errors or rare biological conditions. Which metrics are best tested here?

[fastqc]: https://www.bioinformatics.babraham.ac.uk/projects/fastqc/
[multiqc]: https://multiqc.info/
[picard]: https://software.broadinstitute.org/gatk/documentation/tooldocs/4.1.2.0/picard_sam_ValidateSamFile.php
[qualimap]: http://qualimap.bioinfo.cipf.es/doc_html/command_line.html
[samtools]: http://www.htslib.org/doc/samtools.html
