<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>data_versioning - St. Jude Cloud RFCs</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="0001-rnaseq-workflow-v2.0.0.html"><strong aria-hidden="true">1.</strong> 0001-rnaseq-workflow-v2.0.0</a></li><li class="chapter-item expanded "><a href="0002-scRNA-Seq-workflow.html"><strong aria-hidden="true">2.</strong> 0002-scRNA-Seq-workflow</a></li><li class="chapter-item expanded "><a href="data_versioning.html" class="active"><strong aria-hidden="true">3.</strong> data_versioning</a></li><li class="chapter-item expanded affix "><a href="drafts.html">RFC Drafts</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">St. Jude Cloud RFCs</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents <!-- omit in toc --></a></h1>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#pre-discussion">Pre-Discussion</a></li>
<li><a href="#discussion">Discussion</a></li>
</ul>
<h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>This RFC lays out the Data Versioning process for St. Jude Cloud.</p>
<h1 id="motivation"><a class="header" href="#motivation">Motivation</a></h1>
<p>To provide the community with harmonized data from experiments performed at St. Jude Children's Research Hospital, the St. Jude Cloud team has developed a datatype-specific harmonization workflows. Over time, it is necessary to incorporate bug fixes and other changes in those workflows and the underlying tools. In order to make these changes with minimal impact, we seek to define &quot;data versions&quot;, within which, we have evidence that the workflow results are compatible and not &quot;substantially&quot; different. This RFC will lay out the methods by which we determine what constitutes a significant difference in the resulting data.</p>
<h1 id="pre-discussion"><a class="header" href="#pre-discussion">Pre-Discussion</a></h1>
<p>We have previously had short discussions regarding changes to our data versioning scheme. Currently we attach the pipeline version used to generate the data to the file's metadata. This has left us in a position where we are hesitant to increment pipelines to new versions or update to new versions of underlying tools. We generally agree that there are many pipeline-level changes that do not materially impact the output results. The goal of this RFC is to determine what changes we can be made without creating a new data version. To do so, we also need to generate metrics and data that we can use to justify to users that the results are not different.</p>
<p>There are a number of approaches that could be taken to do this. We could look at alignment information, in which case, we may want to use results from the QC pipeline to justify. Another option is to examine the results from an analysis perspective. If the variant calls are the same (or reasonably the same), that may be sufficient. These are just two limited examples of options we could use.</p>
<p>Currently we have the RNA-Seq workflow v2.0.0 in use for St. Jude Cloud. We have subsequently released improvements, including the integration of XenoCP. This is not in use for production work as we include the pipeline version with the data files in St. Jude Cloud. Creation of a data versioning standard will enable us to roll out bug fixes and new features on an appropriate timeline and provide confidence to ourselves and our users that data is consistent, hopefully, without requiring complete reruns of all data for any change.</p>
<p>We also have issues with the <code>msgen</code> pipeline that is used for WGS and WES. Microsoft has made changes to the pipeline and process throughout the time that we have been using it for production data releases. We have not incremented any versions in that time. So as it stands, we are trusting, without any verification, that any changes introduced are acceptable. </p>
<p>A data versioning process should help us find a reasonable balance that doesn't stop us from making any changes, ever, but also we want to avoid incorporating any and all changes without any assurances, or insight in <code>msgen</code>'s case, that those changes are reasonable and not meaningfully impactful to the data results.</p>
<h1 id="discussion"><a class="header" href="#discussion">Discussion</a></h1>
<h2 id="whole-genome-and-whole-exome-sequencing"><a class="header" href="#whole-genome-and-whole-exome-sequencing">Whole-Genome and Whole-Exome Sequencing</a></h2>
<p>We propose to evaluate whole-genome (WGS) and whole-exome (WES) sequencing by running well characterized samples through each iteration of the analysis pipeline. The resulting variant calls (gVCFs) will be compared to existing high-quality variant calls. This comparison will be conducted using Illumina's <code>hap.py</code> <a href="https://github.com/Illumina/hap.py">comparison tool</a> as <a href="https://www.biorxiv.org/content/10.1101/270157v3">recommended</a> by the Global Alliance for Genomics and Health (GA4GH) Benchmarking Team. Specifically, we propose to run samples from the National Institute for Standards and Technology (NIST)'s Genome in a Bottle (GIAB) project. We will  perform analysis using samples HG002, HG003, HG004, HG005, HG006, and HG007 for WGS. For WES, we will use samples HG002, HG003, HG004, and HG005. The results from prior iterations of the pipeline will be supplied as the truth set. The confident call sets from GIAB will be provided as the gold standard dataset. The variant calls from the new workflow version will be treated as the query.</p>
<h2 id="rna-seq"><a class="header" href="#rna-seq">RNA-Seq</a></h2>
<p>We propose to evaluate RNA sequencing (RNA-Seq) by running well characterized samples through each iteration of the analysis pipeline. Specifically, we propose to run samples from the National Institute for Standards and Technology (NIST)'s Genome in a Bottle (GIAB) project. We will use RNA-Seq data from HG002, HG004, and HG005 samples. These three samples will be run through new iterations of the <a href="https://stjudecloud.github.io/rfcs/0001-rnaseq-workflow-v2.0.0.html">St. Jude Cloud RNA-Seq harmonization workflow</a>. The pipelines will output aligned BAMs and feature count files for each sample. We will then generate variant calls using the <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035531192-RNAseq-short-variant-discovery-SNPs-Indels-">GATK RNA-Seq short variant discovery best practices workflow</a>. We will use Illumina's hap.py comparison tool, along with the high confidence variant calls from GIAB to compare output from prior versions of the RNA-Seq pipeline to the proposed version.</p>
<h3 id="gatk-rna-seq-short-variant-discovery-best-practices-workflow"><a class="header" href="#gatk-rna-seq-short-variant-discovery-best-practices-workflow">GATK RNA-Seq short variant discovery best practices workflow</a></h3>
<p>The GATK best practices workflows are de facto standards for data processing in bioinformatics. Therefore we will reuse their existing workflow for generating variant calls from RNA-Seq data. The workflow accepts a STAR-aligned BAM file, such as those produced by our RNA-Seq alignment harmonization workflow, and produces a set of variant calls by running a number of GATK steps.</p>
<p><img src="../resources/data_versioning/rnaseq-variant-workflow.png" alt="GATK RNA-Seq short variant discovery workflow diagram" /></p>
<h4 id="workflow"><a class="header" href="#workflow">Workflow</a></h4>
<ol>
<li>
<p>Run Picard <code>MarkDuplicates</code></p>
<pre><code class="language-bash">    picard -Xmx~{java_heap_size}g MarkDuplicates \
        -I ~{bam} \
        -O ~{if create_bam then prefix + &quot;.bam&quot; else &quot;/dev/null&quot;} \
        --VALIDATION_STRINGENCY SILENT \
        --CREATE_INDEX ~{create_bam} \
        --CREATE_MD5_FILE ~{create_bam} \
        --COMPRESSION_LEVEL 5 \
        --METRICS_FILE ~{prefix}.metrics.txt
</code></pre>
</li>
<li>
<p>Run GATK <code>SplitNCigarReads</code></p>
<pre><code class="language-bash">    gatk \
        SplitNCigarReads \
        -R ~{fasta} \
        -I ~{bam} \
        -O ~{prefix}.bam \
        -OBM true
   # GATK is unreasonable and uses the plain &quot;.bai&quot; suffix.
   mv ~{prefix}.bai ~{prefix}.bam.bai
</code></pre>
</li>
<li>
<p>Run GATK Spark-enabled <code>BaseRecalibrator</code> (<code>BaseRecalibratorSpark</code>).</p>
<pre><code class="language-bash">     gatk \
         --java-options &quot;-Xms4000m&quot; \
         BaseRecalibratorSpark \
         -R ~{fasta} \
         -I ~{bam} \
         ~{if use_original_quality_scores then &quot;--use-original-qualities&quot; else &quot;&quot; } \
         -O ~{prefix}.txt \
         -known-sites ~{dbSNP_vcf} \
         -known-sites ~{sep=&quot; --known-sites &quot; known_indels_sites_VCFs} \
         --spark-master local[4]
</code></pre>
</li>
<li>
<p>Run GATK Spark-enabled <code>ApplyBQSR</code> (<code>ApplyBQSRSpark</code>).</p>
<pre><code class="language-bash">        gatk \
        --java-options &quot;-Xms3000m&quot; \
        ApplyBQSRSpark \
        --spark-master local[4] \
        -I ~{bam} \
        ~{if use_original_quality_scores then &quot;--use-original-qualities&quot; else &quot;&quot; } \
        -O ~{prefix}.bam \
        --bqsr-recal-file ~{recalibration_report}
</code></pre>
</li>
<li>
<p>Run Picard <code>IntervalListTools</code> to generate list of regions to scatter over.</p>
<pre><code class="language-bash">    picard -Xms1g \
        IntervalListTools \
        SCATTER_COUNT=~{scatter_count} \
        SUBDIVISION_MODE=BALANCING_WITHOUT_INTERVAL_SUBDIVISION_WITH_OVERFLOW \
        UNIQUE=~{unique} \
        SORT=~{sort} \
        INPUT=~{interval_list} \
        OUTPUT=out
</code></pre>
</li>
<li>
<p>Run GATK Spark-enabled <code>HaplotypeCaller</code> (<code>HaplotypeCallerSpark</code>) on each region.</p>
<pre><code class="language-bash">    gatk \
       --java-options &quot;-Xms6000m&quot; \
        HaplotypeCallerSpark \
        -R ~{fasta} \
        -I ~{bam} \
        -L ~{interval_list} \
        -O ~{prefix}.vcf.gz \
        ~{if use_soft_clipped_bases then &quot;&quot; else &quot;--dont-use-soft-clipped-bases&quot;} \
        --standard-min-confidence-threshold-for-calling ~{stand_call_conf} \
       --spark-master local[4]
</code></pre>
</li>
<li>
<p>Run Picard <code>MergeVcfs</code>.</p>
<pre><code class="language-bash">    picard -Xms2000m \
        MergeVcfs \
        ~{sep(' ', prefix('--INPUT=', vcfs))} \
        --OUTPUT ~{output_vcf_name}
</code></pre>
</li>
<li>
<p>Run GATK <code>VariantFiltration</code>.</p>
<pre><code class="language-bash">    gatk \
        VariantFiltration \
            --R ~{fasta} \
            --V ~{vcf} \
            --window ~{window} \
            --cluster ~{cluster} \
             ~{sep(' ', prefix('--filter-name ', filter_name))} \
             ~{sep(' ', prefix('--filter-expression ', squote(filter_expression)))} \
            -O ~{prefix}.vcf.gz
</code></pre>
</li>
</ol>
<h3 id="validation"><a class="header" href="#validation">Validation</a></h3>
<p>After generation of RNA-Seq variants, we will run Illumina's <code>hap.py</code> comparison tool, as recommended by GA4GH, to evaluate the variant calls produced by the newest version of the pipeline compared with those produced by the prior version of the pipeline and compared against the high-quality variant call benchmark set published by GIAB.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="0002-scRNA-Seq-workflow.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="drafts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="0002-scRNA-Seq-workflow.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="drafts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
